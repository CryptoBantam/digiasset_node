<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MetaServer</title>
    <style>
        .table {
            display: table;
            width: auto;
        }
        .row {
            display: table-row;
        }
        .cell {
            display: table-cell;
            border: solid;
            border-width: thin;
        }
        .json {
            font-family: monospace;
            white-space: pre;
        }
        #shadow {
            position:     fixed;
            padding:      0;
            margin:       0;

            top:        0;
            left:       0;

            width:        100%;
            height:       100%;
            background:     rgba(0,0,0,0.5);
            display:      none;
            z-index:      999999;
        }
        #window {
            text-align:     center;
            margin:       0;
            position:       fixed;
            top:        50%;
            left:         50%;
            transform:      translate(-50%, -50%);
            display:      none;

            background-color:   white;
            border-radius:    2px;
            box-shadow:     0 0 15px;
            font-size:      14px;
            font-weight:    bold;
            background-color:   #EEEEEE;
            z-index:      1000000;
            width:        90%;
            height:       90%;
        }
        #window_data {
            width: 100%;
            height:calc(100% - 50px);
        }
        #updateBtn {
            margin-bottom: 10px;
        }
        table {
            background-color:#0066CC;
        }
        thead{
            color: white;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="background-color: #002252 !important;">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" style="color:white">DigiAsset</a>
        <div class="pull-right">
            <div id="last_block" style="color:white">Loading</div>
        </div>
      </div>
    </nav>
    <div style="padding:10px">
        <div id="updateBtn">
            <button class="btn btn-success" >Update Available (Version: 2.2.4)</button>
        </div>
        <h4>Meta Data:</h4>
        <hr class="col-md-8">
        <!--<div id="unsorted" class="table table-responsive">Loading</div>-->
        <div class="table-responsive col-md-8">
            <table class="table table-bordered table-striped" id="unsorted">
                
            </table>
        </div>
        <br>
        <h4>Approved Meta Data</h4>
        <hr class="col-md-8">
        <div class="table-responsive col-md-8">
            <table class="table table-bordered" id="approved">
                
            </table>
        </div>

        <div id="window">
            <iframe id="window_data"></iframe><br>
            <button id="window_approve" class="approve btn btn-success">Approve</button>
            <button id="window_reject" class="reject btn btn-danger">Reject</button>
            <button id="window_close" class="close btn btn-primary">Close</button>
        </div>
        <div id="shadow"></div>
    </div>

    <!-- Button modal -->
    <!--
    TRIGGER MODAL USING FUNCTION 
        var loginM = new bootstrap.Modal(document.getElementById('LoginModal'))
        loginM.show()
    -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#LoginModal">
      Popup Demo
    </button>

    <!-- Modal -->
    <div class="modal fade" id="LoginModal" tabindex="-1" aria-labelledby="MLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="MLabel">Sign in / Sign Up</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
    <!--modal end-->

    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="/js/api.js"></script>
    <script>
        //update every minute the last block scanned.  Value returned is multiple of 1000 blocks not individual block
        let getHeight=async()=>{
            let height=await api.getHeight();
            $("#last_block").html("<strong>Last Block Scanned</strong> : "+height);
        }
        setInterval(getHeight,60000);
        getHeight();

        //show the cid data
        let lists={unsorted:[],approved:[]};
        let redraw=()=> {
            api.list.unsorted().then((cids) => {
                lists.unsorted=cids;
                let html = '<thead><tr><th>Cid</th><th></th><th></th><th></th></tr></thead><tbody>';
                for (let cid of cids) {
                    html += `<tr><td>${cid}</td><td class="cell view button" cid="${cid}" list="unsorted">View</td><td class="cell approve button" cid="${cid}">Approve</td><td class="cell reject button" cid="${cid}">Reject</td></tr>`;
                }
                html += `</tbody>`
                
                $("#unsorted").html(html);
                $('#unsorted').DataTable();
            });
            api.list.approved().then((cids) => {
                lists.approved=cids;
                let html = '<thead><tr><th>Cid</th><th>Btn</th></tr></thead><tbody>';
                for (let cid of cids) {
                    html += `<tr><td>${cid}</td><td class="cell view button" cid="${cid}" list="approved">View</td></tr>`;
                }
                html += `</tbody>`
                $("#approved").html(html);
                $('#approved').DataTable();
            });
        }
        redraw();
        setInterval(redraw,60000);

        //handle view click event
        let list="";
        let showView=async(cid)=>{
            let data=await api.cid(cid);
            if (data.type==="url") {
                $("#window_data").attr('src',data.src);
            } else {
                $("#window_data").contents().find('html').html(data.html);
            }

            $("#window_approve").attr('cid', cid);
            $("#window_reject").attr('cid', cid);
            $("#window").show();
            $("#shadow").show();
        }
        $(document).on('click','.view',function(){
            let cid=$(this).attr('cid');
            list=$(this).attr('list');
            showView(cid);
        });

        //handle approve click event
        $(document).on('click','.approve',function(){
            //approve the meta data
            let cid=$(this).attr('cid');
            api.approve(cid).then(redraw);

            //see if there are more and open next value if there are
            let next="";
            if (list!=="") {
                for (let nextCid of lists[list]) {
                    if (nextCid!==cid) {
                        next=nextCid;
                        break;
                    }
                }
            }

            if (next==="") {
                //close if no more left
                $("#window").hide();
                $("#shadow").hide();
            } else {
                //open next if there are
                showView(next);
            }
        });

        //handle reject click event
        $(document).on('click','.reject',function(){
            let cid=$(this).attr('cid');
            api.reject(cid).then(redraw);

            //see if there are more and open next value if there are
            let next="";
            if (list!=="") {
                for (let nextCid of lists[list]) {
                    if (nextCid!==cid) {
                        next=nextCid;
                        break;
                    }
                }
            }

            if (next==="") {
                //close if no more left
                $("#window").hide();
                $("#shadow").hide();
            } else {
                //open next if there are
                showView(next);
            }
        });

        //handle close click event
        $(document).on('click','.close',function(){
            list="";    //reset list value
            $("#window").hide();
            $("#shadow").hide();
            $("#window_data").attr('src','/blank.html');
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
</body>
</html>